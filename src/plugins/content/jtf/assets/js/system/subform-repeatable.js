/**
 * @copyright  Copyright (C) 2005 - 2017 Open Source Matters, Inc. All rights reserved.
 * @license    GNU General Public License version 2 or later; see LICENSE.txt
 */
!function(e){"use strict";e.subformRepeatable=function(t,o){if(this.$container=e(t),this.$container.data("subformRepeatable"))return a;this.$container.data("subformRepeatable",a),this.options=e.extend({},e.subformRepeatable.defaults,o),this.template="",this.prepareTemplate(),this.$containerRows=this.options.rowsContainer?this.$container.find(this.options.rowsContainer):this.$container,this.lastRowNum=this.$containerRows.find(this.options.repeatableElement).length;var a=this;this.$container.on("click",this.options.btAdd,function(t){t.preventDefault();var o=e(this).parents(a.options.repeatableElement);o.length||(o=null),a.addRow(o)}),this.$container.on("click",this.options.btRemove,function(t){t.preventDefault();var o=e(this).parents(a.options.repeatableElement);a.removeRow(o)}),this.options.btMove&&this.$containerRows.sortable({items:this.options.repeatableElement,handle:this.options.btMove,tolerance:"pointer"}),this.$container.trigger("subform-ready")},e.subformRepeatable.prototype.prepareTemplate=function(){if(this.options.rowTemplateSelector){var t=this.$container.find(this.options.rowTemplateSelector).last().html()||{};this.template=e.trim(t.text||t.textContent)}else{var o=this.$container.find(this.options.repeatableElement).get(0),a=e(o).clone();try{this.clearScripts(a)}catch(e){window.console&&console.log(e)}this.template=a.prop("outerHTML")}},e.subformRepeatable.prototype.addRow=function(t){var o=this.$containerRows.find(this.options.repeatableElement).length;if(o>=this.options.maximum)return null;var a=e.parseHTML(this.template);t?e(t).after(a):this.$containerRows.append(a);var i=e(a);i.attr("data-new","true"),this.fixUniqueAttributes(i,o);try{this.fixScripts(i)}catch(e){window.console&&console.log(e)}return this.$container.trigger("subform-row-add",i),i},e.subformRepeatable.prototype.removeRow=function(e){this.$containerRows.find(this.options.repeatableElement).length<=this.options.minimum||(this.$container.trigger("subform-row-remove",e),e.remove())},e.subformRepeatable.prototype.fixUniqueAttributes=function(t,o,a,i){var r=void 0===a?t.attr("data-group"):a,n=void 0===i?t.attr("data-base-name"):i,s=void 0===o?0:o,l=Math.max(this.lastRowNum,s),p=n+l;this.lastRowNum=l+1,t.attr("data-group",p);for(var f=t.find("[name]"),c={},d=0,h=f.length;d<h;d++){var u=e(f[d]),m=u.attr("name"),b=m.replace(/(\[\]$)/g,"").replace(/(\]\[)/g,"__").replace(/\[/g,"_").replace(/\]/g,""),v=m.replace("["+r+"][","["+p+"]["),w=b.replace(r,p),R=0,g=b;"checkbox"===u.prop("type")&&m.match(/\[\]$/)?((R=c[b]?c[b].length:0)||(u.closest("fieldset.checkboxes").attr("id",w),t.find('label[for="'+b+'"]').attr("for",w).attr("id",w+"-lbl")),g+=R,w+=R):"radio"===u.prop("type")&&((R=c[b]?c[b].length:0)||(u.closest("fieldset.radio").attr("id",w),t.find('label[for="'+b+'"]').attr("for",w).attr("id",w+"-lbl")),g+=R,w+=R),c[b]?c[b].push(!0):c[b]=[!0],u.attr("name",v),u.attr("id",w),t.find('label[for="'+g+'"]').attr("for",w).attr("id",w+"-lbl")}for(var $=t.find(this.options.rowTemplateSelector),x=0;x<$.length;x++){var y=e(e($[x]).prop("content"));this.fixUniqueAttributes(y,s,r,n)}},e.subformRepeatable.prototype.clearScripts=function(t){e.fn.chosen&&t.find("select.chzn-done").each(function(){var t=e(this);t.next(".chzn-container").remove(),t.show().addClass("fix-chosen")})},e.subformRepeatable.prototype.fixScripts=function(t){t.find('a[onclick*="jInsertFieldValue"]').each(function(){var t=e(this),o=t.siblings('input[type="text"]').attr("id"),a=t.prev(),i=a.attr("href");t.attr("onclick","jInsertFieldValue('', '"+o+"');return false;"),a.attr("href",i.replace(/&fieldid=(.+)&/,"&fieldid="+o+"&"))}),e.fn.fieldMedia&&t.find(".field-media-wrapper").fieldMedia(),e.fn.tooltip&&t.find(".hasTooltip").tooltip({html:!0,container:"body"}),e.fn.fieldUser&&t.find(".field-user-wrapper").fieldUser(),window.SqueezeBox&&window.SqueezeBox.assign&&SqueezeBox.assign(t.find("a.modal").get(),{parse:"rel"}),t.find("div.subform-repeatable").subformRepeatable()},e.subformRepeatable.defaults={btAdd:".group-add",btRemove:".group-remove",btMove:".group-move",minimum:0,maximum:10,repeatableElement:".subform-repeatable-group",rowTemplateSelector:"template.subform-repeatable-template-section",rowsContainer:null},e.fn.subformRepeatable=function(t){return this.each(function(){var t=t||{},o=e(this).data();if(!o.subformRepeatable){for(var a in o)o.hasOwnProperty(a)&&(t[a]=o[a]);var i=new e.subformRepeatable(this,t);e(this).data("subformRepeatable",i)}})},e(window).on("load",function(){e("div.subform-repeatable").subformRepeatable()})}(jQuery);